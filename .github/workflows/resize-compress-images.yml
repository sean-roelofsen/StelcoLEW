name: Resize & Compress Images (Fix GitHub Permissions)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub Actions tab

jobs:
  optimize-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Use GitHub token for authentication

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.x"

      - name: Install Required Dependencies
        run: pip install pillow

      - name: Resize and Compress Images
        run: |
          python - <<EOF
          from PIL import Image
          import os

          # Define folders to process
          image_folders = ["images", "images2"]
          max_width = 3000  # Maintain 4:3 aspect ratio (originals are 4000x3000)
          max_height = 2250 
          quality = 75       # JPEG quality (lower = smaller file)

          modified_files = False  # Track if any images were modified

          for folder in image_folders:
              if not os.path.exists(folder):
                  continue  # Skip missing folders

              for filename in os.listdir(folder):
                  if filename.lower().endswith(('.jpg', '.jpeg')):  
                      img_path = os.path.join(folder, filename)
                      img = Image.open(img_path)

                      # Resize while keeping aspect ratio
                      img.thumbnail((max_width, max_height), Image.LANCZOS)

                      # Overwrite original image with optimized version
                      img.save(img_path, "JPEG", quality=quality, optimize=True)
                      print(f"âœ” Compressed {filename} in {folder}")
                      modified_files = True  # Flag that we modified images

          if not modified_files:
              print("âœ… No images needed optimization. Exiting without commit.")
              exit(0)  # Stop the workflow if no images were changed

          print("âœ… All images resized & compressed successfully!")
          EOF

      - name: Commit and Push Optimized Images
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Add only modified images
          git add images/*.jpg images/*.jpeg images2/*.jpg images2/*.jpeg 2>/dev/null || true

          # Commit only if there are changes
          git diff --cached --quiet || git commit -m "ðŸ”§ Auto-resized & compressed images (4:3)"
          
          # Push changes using GitHub Actions token
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git main
